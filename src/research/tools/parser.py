from pydantic import BaseModel, Field
from langchain_core.prompts import ChatPromptTemplate
from research.log_output.log import log
from research.tools.llm import LLMTool
from research.tools.github import WorkflowResult
from research.tools.linter import LintResult
import re

class ParseResult(BaseModel):
    parse_details: str | None = Field(None, description="パースの詳細")


class ParserTool:
    def __init__(self, model_name: str = "gemini"):
        """
        Returns:
            None
        """
        self.llm = LLMTool().create_model(
            model_name=model_name, 
            output_model=ParseResult
        )

    def workflow_log_parse(self, workflow_result: WorkflowResult) -> ParseResult:

        """
		WorkflowResult型の変数をLLMプロンプト用に整形し、
		エラー内容をわかりやすく辞書形式で返す。

		Returns:
			ParseResult: parse_details(str|None)
		"""
		
        status = workflow_result.status
        conclusion = workflow_result.conclusion
        message = workflow_result.message
        failure_reason = self.extract_error_context(workflow_result.failure_reason) if workflow_result.failure_reason else None

        parse_details = None

        if conclusion is None:
            parse_details = f"ワークフロー結果が存在しません。{message or ''}"
        elif conclusion == "success":
            parse_details = f"ワークフロー結果は成功したためエラーはありませんでした。{message or ''}"
        else:
            # failの場合
            prompt = ChatPromptTemplate.from_messages(
                [
                    (
                        "system",
                        "あなたは日本のソフトウェア開発の専門家です。",
                    ),
                    (
                        "human",
                        "以下のGitHub Actionsのワークフロー実行結果に基づいてエラーの詳細をわかりやすく教えてください。\n"
                        "ワークフローの実行状態: {status}\n"
                        "ワークフローの実行結果: {conclusion}\n"
                        "ワークフロー実行結果の内容: {message}\n"
                        "ワークフロー実行の失敗理由: {failure_reason}\n"
                        "注意事項:\n"
                        "- プロジェクト内のファイルは変更せず、ymlファイルのみの修正でエラーの解決を図ってください。\n"
                        
                    )
                ]
            )
            chain = prompt | self.llm
            result = chain.invoke(
                {
                    "status": status,
                    "conclusion": conclusion,
                    "message": message,
                    "failure_reason": failure_reason,
                }
            )
            log(conclusion, f"ワークフロー実行ログパーサー結果: {result.parse_details}")
            return result
        
        log(conclusion, f"ワークフロー実行ログパーサー結果: {parse_details or 'No parse details'}")
        return ParseResult(
            parse_details=parse_details
        )

    def lint_result_parse(self, lint_result: LintResult) -> ParseResult:

        """
        LintResult型の変数をLLMプロンプト用に整形し、
        エラー内容と修正案をわかりやすく辞書形式で返す。

        Returns:
            LintParseResult: error_details(str|None)
        """
        local_path = lint_result.local_path
        status = lint_result.status
        error_message = lint_result.error_message
        raw_output = lint_result.raw_output

        parse_details = None

        if status is None:
            parse_details = f"Lint未実行または対象ディレクトリが存在しません。{error_message or ''}"
        elif status == "linter_error":
            parse_details = f"Linter自体の実行に失敗しました。エラーメッセージ: {error_message or ''}"
        elif status == "success":
            parse_details = "問題は検出されませんでした。"
        else:
            # failの場合
            llm_prompt = ChatPromptTemplate.from_messages(
                [
                    (
                        "system",
                        "あなたは日本のソフトウェア開発の専門家です。",
                    ),
                    (
                        "human",
                        "以下はGitHub Actionsのlint結果です。エラーの詳細をわかりやすく教えてください。\n"
                        "local_path: {local_path}\n"
                        "status: {status}\n"
                        "error_message: {error_message}\n"
                        "raw_output: {raw_output}\n"
                    )
                ]
            )

            chain = llm_prompt | self.llm
            result = chain.invoke({
                "local_path": local_path,
                "status": status,
                "error_message": error_message,
                "raw_output": raw_output
            })
            log("info", f"Lintパーサー結果: {result.parse_details}")
            return result

        log("info", f"Lintパーサー結果: {parse_details or 'No parse details'}")
        return ParseResult(
            parse_details=parse_details,
        )

    
    def extract_error_context(self, log: str, context: int = 5) -> str:
        """
        ログからエラー周辺の行だけを抽出する。
        context: エラー行の前後に残す行数
        """
        lines = log.splitlines()
        keep_indices = set()

        # エラーっぽいキーワード
        error_keywords = [
            r"error", r"fail", r"exception", r"traceback", r"exit code",
            r"not found", r"is required", r"permission denied"
        ]

        for i, line in enumerate(lines):
            if any(re.search(pat, line, re.IGNORECASE) for pat in error_keywords):
                # マッチしたら前後のコンテキストを追加
                for j in range(max(0, i-context), min(len(lines), i+context+1)):
                    keep_indices.add(j)

        # 抽出した行だけ返す
        filtered_lines = [lines[i] for i in sorted(keep_indices)]
        return "\n".join(filtered_lines)

if __name__ == "__main__":
    # テストコード
    parser = ParserTool(model_name="gemini-2.5-flash")
    test_log = "===== 1_Build and Lint.txt =====\n﻿2025-10-05T04:43:39.9818121Z Current runner version: '2.328.0'\n2025-10-05T04:43:39.9841640Z ##[group]Runner Image Provisioner\n2025-10-05T04:43:39.9842451Z Hosted Compute Agent\n2025-10-05T04:43:39.9843084Z Version: 20250912.392\n2025-10-05T04:43:39.9843665Z Commit: d921fda672a98b64f4f82364647e2f10b2267d0b\n2025-10-05T04:43:39.9844356Z Build Date: 2025-09-12T15:23:14Z\n2025-10-05T04:43:39.9845014Z ##[endgroup]\n2025-10-05T04:43:39.9845593Z ##[group]Operating System\n2025-10-05T04:43:39.9846114Z Ubuntu\n2025-10-05T04:43:39.9846647Z 24.04.3\n2025-10-05T04:43:39.9847080Z LTS\n2025-10-05T04:43:39.9847561Z ##[endgroup]\n2025-10-05T04:43:39.9848093Z ##[group]Runner Image\n2025-10-05T04:43:39.9848617Z Image: ubuntu-24.04\n2025-10-05T04:43:39.9849117Z Version: 20250929.60.1\n2025-10-05T04:43:39.9850093Z Included Software: https://github.com/actions/runner-images/blob/ubuntu24/20250929.60/images/ubuntu/Ubuntu2404-Readme.md\n2025-10-05T04:43:39.9851887Z Image Release: https://github.com/actions/runner-images/releases/tag/ubuntu24%2F20250929.60\n2025-10-05T04:43:39.9852985Z ##[endgroup]\n2025-10-05T04:43:39.9854012Z ##[group]GITHUB_TOKEN Permissions\n2025-10-05T04:43:39.9856626Z Contents: read\n2025-10-05T04:43:39.9857180Z Metadata: read\n2025-10-05T04:43:39.9857682Z ##[endgroup]\n2025-10-05T04:43:39.9859624Z Secret source: Actions\n2025-10-05T04:43:39.9860784Z Prepare workflow directory\n2025-10-05T04:43:40.0252620Z Prepare all required actions\n2025-10-05T04:43:40.0308169Z Getting action download info\n2025-10-05T04:43:40.4342402Z Download action repository 'actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955' (SHA:08eba0b27e820071cde6df949e0beb9ba4906955)\n2025-10-05T04:43:40.6034786Z Download action repository 'actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065' (SHA:a26af69be951a213d495a4c3e4e4022e16d87065)\n2025-10-05T04:43:40.8756921Z Download action repository 'actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830' (SHA:0057852bfaa89a56745cba8c7296529d2fc39830)\n2025-10-05T04:43:40.9752311Z Download action repository 'actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02' (SHA:ea165f8d65b6e75b540449e92b4886f43607fa02)\n2025-10-05T04:43:41.1946734Z Complete job name: Build and Lint\n2025-10-05T04:43:41.2756069Z ##[group]Run actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955\n2025-10-05T04:43:41.2757746Z with:\n2025-10-05T04:43:41.2758503Z   persist-credentials: false\n2025-10-05T04:43:41.2759441Z   repository: asato425/manim\n2025-10-05T04:43:41.2760573Z   token: ***\n2025-10-05T04:43:41.2761309Z   ssh-strict: true\n2025-10-05T04:43:41.2762401Z   ssh-user: git\n2025-10-05T04:43:41.2763200Z   clean: true\n2025-10-05T04:43:41.2763991Z   sparse-checkout-cone-mode: true\n2025-10-05T04:43:41.2764949Z   fetch-depth: 1\n2025-10-05T04:43:41.2765728Z   fetch-tags: false\n2025-10-05T04:43:41.2766515Z   show-progress: true\n2025-10-05T04:43:41.2767294Z   lfs: false\n2025-10-05T04:43:41.2768014Z   submodules: false\n2025-10-05T04:43:41.2768816Z   set-safe-directory: true\n2025-10-05T04:43:41.2769996Z ##[endgroup]\n2025-10-05T04:43:41.3843656Z Syncing repository: asato425/manim\n2025-10-05T04:43:41.3847561Z ##[group]Getting Git version info\n2025-10-05T04:43:41.3849986Z Working directory is '/home/runner/work/manim/manim'\n2025-10-05T04:43:41.3852794Z [command]/usr/bin/git version\n2025-10-05T04:43:41.3927236Z git version 2.51.0\n2025-10-05T04:43:41.3954991Z ##[endgroup]\n2025-10-05T04:43:41.3978028Z Temporarily overriding HOME='/home/runner/work/_temp/3841c34c-236d-4919-a6b2-f9ec797972bd' before making global git config changes\n2025-10-05T04:43:41.3983021Z Adding repository directory to the temporary git global config as a safe directory\n2025-10-05T04:43:41.3986619Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/manim/manim\n2025-10-05T04:43:41.4022001Z Deleting the contents of '/home/runner/work/manim/manim'\n2025-10-05T04:43:41.4025829Z ##[group]Initializing the repository\n2025-10-05T04:43:41.4030644Z [command]/usr/bin/git init /home/runner/work/manim/manim\n2025-10-05T04:43:41.4146744Z hint: Using 'master' as the name for the initial branch. This default branch name\n2025-10-05T04:43:41.4149567Z hint: is subject to change. To configure the initial branch name to use in all\n2025-10-05T04:43:41.4152449Z hint: of your new repositories, which will suppress this warning, call:\n2025-10-05T04:43:41.4154823Z hint:\n2025-10-05T04:43:41.4156382Z hint: \tgit config --global init.defaultBranch <name>\n2025-10-05T04:43:41.4158552Z hint:\n2025-10-05T04:43:41.4160360Z hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and\n2025-10-05T04:43:41.4163769Z hint: 'development'. The just-created branch can be renamed via this command:\n2025-10-05T04:43:41.4166270Z hint:\n2025-10-05T04:43:41.4167459Z hint: \tgit branch -m <name>\n2025-10-05T04:43:41.4168832Z hint:\n2025-10-05T04:43:41.4170546Z hint: Disable this message with \"git config set advice.defaultBranchName false\"\n2025-10-05T04:43:41.4172596Z Initialized empty Git repository in /home/runner/work/manim/manim/.git/\n2025-10-05T04:43:41.4176101Z [command]/usr/bin/git remote add origin https://github.com/asato425/manim\n2025-10-05T04:43:41.4204807Z ##[endgroup]\n2025-10-05T04:43:41.4207187Z ##[group]Disabling automatic garbage collection\n2025-10-05T04:43:41.4209533Z [command]/usr/bin/git config --local gc.auto 0\n2025-10-05T04:43:41.4238804Z ##[endgroup]\n2025-10-05T04:43:41.4241003Z ##[group]Setting up auth\n2025-10-05T04:43:41.4246528Z [command]/usr/bin/git config --local --name-only --get-regexp core\\.sshCommand\n2025-10-05T04:43:41.4279626Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'core\\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :\"\n2025-10-05T04:43:41.4629101Z [command]/usr/bin/git config --local --name-only --get-regexp http\\.https\\:\\/\\/github\\.com\\/\\.extraheader\n2025-10-05T04:43:41.4662386Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'http\\.https\\:\\/\\/github\\.com\\/\\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :\"\n2025-10-05T04:43:41.4876531Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***\n2025-10-05T04:43:41.4911151Z ##[endgroup]\n2025-10-05T04:43:41.4913725Z ##[group]Fetching the repository\n2025-10-05T04:43:41.4923015Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +fd6f9b8538a1d795010d0d65aea89b7b71984efe:refs/remotes/origin/work_1005_1303\n2025-10-05T04:43:41.8591185Z From https://github.com/asato425/manim\n2025-10-05T04:43:41.8594098Z  * [new ref]         fd6f9b8538a1d795010d0d65aea89b7b71984efe -> origin/work_1005_1303\n2025-10-05T04:43:41.8628233Z ##[endgroup]\n2025-10-05T04:43:41.8630371Z ##[group]Determining the checkout info\n2025-10-05T04:43:41.8633089Z ##[endgroup]\n2025-10-05T04:43:41.8635417Z [command]/usr/bin/git sparse-checkout disable\n2025-10-05T04:43:41.8679318Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig\n2025-10-05T04:43:41.8709033Z ##[group]Checking out the ref\n2025-10-05T04:43:41.8712304Z [command]/usr/bin/git checkout --progress --force -B work_1005_1303 refs/remotes/origin/work_1005_1303\n2025-10-05T04:43:41.8892420Z Switched to a new branch 'work_1005_1303'\n2025-10-05T04:43:41.8896057Z branch 'work_1005_1303' set up to track 'origin/work_1005_1303'.\n2025-10-05T04:43:41.8903046Z ##[endgroup]\n2025-10-05T04:43:41.8939340Z [command]/usr/bin/git log -1 --format=%H\n2025-10-05T04:43:41.8962388Z fd6f9b8538a1d795010d0d65aea89b7b71984efe\n2025-10-05T04:43:41.8976022Z ##[group]Removing auth\n2025-10-05T04:43:41.8981169Z [command]/usr/bin/git config --local --name-only --get-regexp core\\.sshCommand\n2025-10-05T04:43:41.9014007Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'core\\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :\"\n2025-10-05T04:43:41.9255315Z [command]/usr/bin/git config --local --name-only --get-regexp http\\.https\\:\\/\\/github\\.com\\/\\.extraheader\n2025-10-05T04:43:41.9277046Z http.https://github.com/.extraheader\n2025-10-05T04:43:41.9286757Z [command]/usr/bin/git config --local --unset-all http.https://github.com/.extraheader\n2025-10-05T04:43:41.9318670Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'http\\.https\\:\\/\\/github\\.com\\/\\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :\"\n2025-10-05T04:43:41.9527076Z ##[endgroup]\n2025-10-05T04:43:41.9790045Z ##[group]Run actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065\n2025-10-05T04:43:41.9791372Z with:\n2025-10-05T04:43:41.9792378Z   python-version: 3.10\n2025-10-05T04:43:41.9793155Z   check-latest: false\n2025-10-05T04:43:41.9794126Z   token: ***\n2025-10-05T04:43:41.9794843Z   update-environment: true\n2025-10-05T04:43:41.9795680Z   allow-prereleases: false\n2025-10-05T04:43:41.9796509Z   freethreaded: false\n2025-10-05T04:43:41.9797248Z ##[endgroup]\n2025-10-05T04:43:42.1551629Z ##[group]Installed versions\n2025-10-05T04:43:42.1669318Z Successfully set up CPython (3.10.18)\n2025-10-05T04:43:42.1672074Z ##[endgroup]\n2025-10-05T04:43:42.2417864Z ##[group]Run actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830\n2025-10-05T04:43:42.2419089Z with:\n2025-10-05T04:43:42.2419749Z   path: ~/.cache/pip\n2025-10-05T04:43:42.2421166Z   key: Linux-python-3.10.18-pip-70233f87bcb367b6f1a53d0e85e8cf9d82b514bd7af2d0eef0416538bbd28a66\n2025-10-05T04:43:42.2423191Z   restore-keys: Linux-python-3.10.18-pip-\n\n2025-10-05T04:43:42.2424211Z   enableCrossOsArchive: false\n2025-10-05T04:43:42.2425085Z   fail-on-cache-miss: false\n2025-10-05T04:43:42.2425922Z   lookup-only: false\n2025-10-05T04:43:42.2489415Z   save-always: false\n2025-10-05T04:43:42.2490216Z env:\n2025-10-05T04:43:42.2491604Z   pythonLocation: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.2493118Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.10.18/x64/lib/pkgconfig\n2025-10-05T04:43:42.2494576Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.2495870Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.2497251Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.2498567Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.10.18/x64/lib\n2025-10-05T04:43:42.2499665Z ##[endgroup]\n2025-10-05T04:43:42.5365329Z Cache not found for input keys: Linux-python-3.10.18-pip-70233f87bcb367b6f1a53d0e85e8cf9d82b514bd7af2d0eef0416538bbd28a66, Linux-python-3.10.18-pip-\n2025-10-05T04:43:42.5472990Z ##[group]Run python -m pip install --upgrade pip\n2025-10-05T04:43:42.5474290Z \u001b[36;1mpython -m pip install --upgrade pip\u001b[0m\n2025-10-05T04:43:42.5475415Z \u001b[36;1mpip install -r requirements.txt\u001b[0m\n2025-10-05T04:43:42.5476433Z \u001b[36;1mpip install -e .\u001b[0m\n2025-10-05T04:43:42.5574102Z shell: /usr/bin/bash -e {0}\n2025-10-05T04:43:42.5575012Z env:\n2025-10-05T04:43:42.5575957Z   pythonLocation: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.5577552Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.10.18/x64/lib/pkgconfig\n2025-10-05T04:43:42.5579134Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.5580582Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.5582175Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.5583610Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.10.18/x64/lib\n2025-10-05T04:43:42.5584822Z ##[endgroup]\n2025-10-05T04:43:49.8068854Z Requirement already satisfied: pip in /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages (25.2)\n2025-10-05T04:43:50.9106213Z Ignoring audioop-lts: markers 'python_version >= \"3.13\"' don't match your environment\n2025-10-05T04:43:50.9586517Z Collecting addict (from -r requirements.txt (line 1))\n2025-10-05T04:43:51.0036851Z   Downloading addict-2.4.0-py3-none-any.whl.metadata (1.0 kB)\n2025-10-05T04:43:51.0142298Z Collecting appdirs (from -r requirements.txt (line 2))\n2025-10-05T04:43:51.0178175Z   Downloading appdirs-1.4.4-py2.py3-none-any.whl.metadata (9.0 kB)\n2025-10-05T04:43:51.0298655Z Collecting colour (from -r requirements.txt (line 4))\n2025-10-05T04:43:51.0348344Z   Downloading colour-0.1.5-py2.py3-none-any.whl.metadata (18 kB)\n2025-10-05T04:43:51.0625718Z Collecting diskcache (from -r requirements.txt (line 5))\n2025-10-05T04:43:51.0686221Z   Downloading diskcache-5.6.3-py3-none-any.whl.metadata (20 kB)\n2025-10-05T04:43:51.1279118Z Collecting ipython>=8.18.0 (from -r requirements.txt (line 6))\n2025-10-05T04:43:51.1320140Z   Downloading ipython-8.37.0-py3-none-any.whl.metadata (5.1 kB)\n2025-10-05T04:43:51.1538842Z Collecting isosurfaces (from -r requirements.txt (line 7))\n2025-10-05T04:43:51.1594379Z   Downloading isosurfaces-0.1.2-py3-none-any.whl.metadata (3.3 kB)\n2025-10-05T04:43:51.3422683Z Collecting fontTools (from -r requirements.txt (line 8))\n2025-10-05T04:43:51.3462675Z   Downloading fonttools-4.60.1-cp310-cp310-manylinux2014_x86_64.manylinux_2_17_x86_64.whl.metadata (112 kB)\n2025-10-05T04:43:51.4063676Z Collecting manimpango>=0.6.0 (from -r requirements.txt (line 9))\n2025-10-05T04:43:51.4115720Z   Downloading manimpango-0.6.0.tar.gz (4.1 MB)\n2025-10-05T04:43:51.4403916Z      ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 4.1/4.1 MB 151.0 MB/s  0:00:00\n2025-10-05T04:43:51.5472476Z   Installing build dependencies: started\n2025-10-05T04:43:53.3087499Z   Installing build dependencies: finished with status 'done'\n2025-10-05T04:43:53.3093542Z   Getting requirements to build wheel: started\n2025-10-05T04:43:53.9521698Z   Getting requirements to build wheel: finished with status 'error'\n2025-10-05T04:43:53.9573070Z   error: subprocess-exited-with-error\n2025-10-05T04:43:53.9573684Z   \n2025-10-05T04:43:53.9574443Z   × Getting requirements to build wheel did not run successfully.\n2025-10-05T04:43:53.9575125Z   │ exit code: 1\n2025-10-05T04:43:53.9575523Z   ╰─> [25 lines of output]\n2025-10-05T04:43:53.9575950Z       Package 'pangocairo' was not found\n2025-10-05T04:43:53.9576485Z       Traceback (most recent call last):\n2025-10-05T04:43:53.9585082Z         File \"<string>\", line 137, in check_min_version\n2025-10-05T04:43:53.9586210Z         File \"/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/subprocess.py\", line 369, in check_call\n2025-10-05T04:43:53.9587177Z           raise CalledProcessError(retcode, cmd)\n2025-10-05T04:43:53.9588307Z       subprocess.CalledProcessError: Command '['pkg-config', '--print-errors', '--atleast-version', '1.30.0', 'pangocairo']' returned non-zero exit status 1.\n2025-10-05T04:43:53.9589392Z       \n2025-10-05T04:43:53.9590291Z       During handling of the above exception, another exception occurred:\n2025-10-05T04:43:53.9590947Z       \n2025-10-05T04:43:53.9591268Z       Traceback (most recent call last):\n2025-10-05T04:43:53.9592787Z         File \"/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py\", line 389, in <module>\n2025-10-05T04:43:53.9593968Z           main()\n2025-10-05T04:43:53.9595100Z         File \"/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py\", line 373, in main\n2025-10-05T04:43:53.9596408Z           json_out[\"return_val\"] = hook(**hook_input[\"kwargs\"])\n2025-10-05T04:43:53.9597881Z         File \"/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py\", line 143, in get_requires_for_build_wheel\n2025-10-05T04:43:53.9599216Z           return hook(config_settings)\n2025-10-05T04:43:53.9600430Z         File \"/tmp/pip-build-env-338iybi2/overlay/lib/python3.10/site-packages/setuptools/build_meta.py\", line 331, in get_requires_for_build_wheel\n2025-10-05T04:43:53.9601862Z           return self._get_build_requires(config_settings, requirements=[])\n2025-10-05T04:43:53.9603157Z         File \"/tmp/pip-build-env-338iybi2/overlay/lib/python3.10/site-packages/setuptools/build_meta.py\", line 301, in _get_build_requires\n2025-10-05T04:43:53.9604223Z           self.run_setup()\n2025-10-05T04:43:53.9605288Z         File \"/tmp/pip-build-env-338iybi2/overlay/lib/python3.10/site-packages/setuptools/build_meta.py\", line 317, in run_setup\n2025-10-05T04:43:53.9606628Z           exec(code, locals())\n2025-10-05T04:43:53.9607172Z         File \"<string>\", line 204, in <module>\n2025-10-05T04:43:53.9607802Z         File \"<string>\", line 140, in check_min_version\n2025-10-05T04:43:53.9608432Z       __main__.RequiredDependencyException: pangocairo >= 1.30.0 is required\n2025-10-05T04:43:53.9608965Z       [end of output]\n2025-10-05T04:43:53.9609264Z   \n2025-10-05T04:43:53.9609741Z   note: This error originates from a subprocess, and is likely not a problem with pip.\n2025-10-05T04:43:53.9610444Z error: subprocess-exited-with-error\n2025-10-05T04:43:53.9610738Z \n2025-10-05T04:43:53.9611323Z × Getting requirements to build wheel did not run successfully.\n2025-10-05T04:43:53.9612204Z │ exit code: 1\n2025-10-05T04:43:53.9612632Z ╰─> See above for output.\n2025-10-05T04:43:53.9612887Z \n2025-10-05T04:43:53.9613295Z note: This error originates from a subprocess, and is likely not a problem with pip.\n2025-10-05T04:43:54.0382279Z ##[error]Process completed with exit code 1.\n2025-10-05T04:43:54.0501885Z Post job cleanup.\n2025-10-05T04:43:54.1433772Z [command]/usr/bin/git version\n2025-10-05T04:43:54.1476879Z git version 2.51.0\n2025-10-05T04:43:54.1523184Z Temporarily overriding HOME='/home/runner/work/_temp/d963074a-ed7f-4dcf-b080-ca47bdcbbdc7' before making global git config changes\n2025-10-05T04:43:54.1524605Z Adding repository directory to the temporary git global config as a safe directory\n2025-10-05T04:43:54.1537332Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/manim/manim\n2025-10-05T04:43:54.1573529Z [command]/usr/bin/git config --local --name-only --get-regexp core\\.sshCommand\n2025-10-05T04:43:54.1606002Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'core\\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :\"\n2025-10-05T04:43:54.1829689Z [command]/usr/bin/git config --local --name-only --get-regexp http\\.https\\:\\/\\/github\\.com\\/\\.extraheader\n2025-10-05T04:43:54.1861198Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'http\\.https\\:\\/\\/github\\.com\\/\\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :\"\n2025-10-05T04:43:54.2181097Z Cleaning up orphan processes\n\n\n===== Build and Lint/system.txt =====\n2025-10-05T04:43:37.0980000Z Requested labels: ubuntu-latest\n2025-10-05T04:43:37.0980000Z Job defined at: asato425/manim/.github/workflows/ci.yml@refs/heads/work_1005_1303\n2025-10-05T04:43:37.0980000Z Waiting for a runner to pick up this job...\n2025-10-05T04:43:37.5960000Z Job is waiting for a hosted runner to come online.\n2025-10-05T04:43:37.5960000Z Job is about to start running on the hosted runner: GitHub Actions 1000000734\n\n===== Build and Lint/1_Set up job.txt =====\n﻿2025-10-05T04:43:39.9817063Z Current runner version: '2.328.0'\n2025-10-05T04:43:39.9841615Z ##[group]Runner Image Provisioner\n2025-10-05T04:43:39.9842445Z Hosted Compute Agent\n2025-10-05T04:43:39.9843079Z Version: 20250912.392\n2025-10-05T04:43:39.9843660Z Commit: d921fda672a98b64f4f82364647e2f10b2267d0b\n2025-10-05T04:43:39.9844352Z Build Date: 2025-09-12T15:23:14Z\n2025-10-05T04:43:39.9845009Z ##[endgroup]\n2025-10-05T04:43:39.9845589Z ##[group]Operating System\n2025-10-05T04:43:39.9846111Z Ubuntu\n2025-10-05T04:43:39.9846644Z 24.04.3\n2025-10-05T04:43:39.9847077Z LTS\n2025-10-05T04:43:39.9847558Z ##[endgroup]\n2025-10-05T04:43:39.9848037Z ##[group]Runner Image\n2025-10-05T04:43:39.9848614Z Image: ubuntu-24.04\n2025-10-05T04:43:39.9849114Z Version: 20250929.60.1\n2025-10-05T04:43:39.9850089Z Included Software: https://github.com/actions/runner-images/blob/ubuntu24/20250929.60/images/ubuntu/Ubuntu2404-Readme.md\n2025-10-05T04:43:39.9851684Z Image Release: https://github.com/actions/runner-images/releases/tag/ubuntu24%2F20250929.60\n2025-10-05T04:43:39.9852980Z ##[endgroup]\n2025-10-05T04:43:39.9854008Z ##[group]GITHUB_TOKEN Permissions\n2025-10-05T04:43:39.9856603Z Contents: read\n2025-10-05T04:43:39.9857176Z Metadata: read\n2025-10-05T04:43:39.9857679Z ##[endgroup]\n2025-10-05T04:43:39.9859607Z Secret source: Actions\n2025-10-05T04:43:39.9860776Z Prepare workflow directory\n2025-10-05T04:43:40.0252586Z Prepare all required actions\n2025-10-05T04:43:40.0308141Z Getting action download info\n2025-10-05T04:43:40.4342357Z Download action repository 'actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955' (SHA:08eba0b27e820071cde6df949e0beb9ba4906955)\n2025-10-05T04:43:40.6034733Z Download action repository 'actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065' (SHA:a26af69be951a213d495a4c3e4e4022e16d87065)\n2025-10-05T04:43:40.8756887Z Download action repository 'actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830' (SHA:0057852bfaa89a56745cba8c7296529d2fc39830)\n2025-10-05T04:43:40.9752249Z Download action repository 'actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02' (SHA:ea165f8d65b6e75b540449e92b4886f43607fa02)\n2025-10-05T04:43:41.1946708Z Complete job name: Build and Lint\n\n\n===== Build and Lint/2_Checkout repository.txt =====\n﻿2025-10-05T04:43:41.2756039Z ##[group]Run actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955\n2025-10-05T04:43:41.2757736Z with:\n2025-10-05T04:43:41.2758498Z   persist-credentials: false\n2025-10-05T04:43:41.2759437Z   repository: asato425/manim\n2025-10-05T04:43:41.2760569Z   token: ***\n2025-10-05T04:43:41.2761305Z   ssh-strict: true\n2025-10-05T04:43:41.2762392Z   ssh-user: git\n2025-10-05T04:43:41.2763195Z   clean: true\n2025-10-05T04:43:41.2763986Z   sparse-checkout-cone-mode: true\n2025-10-05T04:43:41.2764939Z   fetch-depth: 1\n2025-10-05T04:43:41.2765723Z   fetch-tags: false\n2025-10-05T04:43:41.2766512Z   show-progress: true\n2025-10-05T04:43:41.2767291Z   lfs: false\n2025-10-05T04:43:41.2768010Z   submodules: false\n2025-10-05T04:43:41.2768811Z   set-safe-directory: true\n2025-10-05T04:43:41.2769984Z ##[endgroup]\n2025-10-05T04:43:41.3843595Z Syncing repository: asato425/manim\n2025-10-05T04:43:41.3847532Z ##[group]Getting Git version info\n2025-10-05T04:43:41.3849872Z Working directory is '/home/runner/work/manim/manim'\n2025-10-05T04:43:41.3852773Z [command]/usr/bin/git version\n2025-10-05T04:43:41.3927202Z git version 2.51.0\n2025-10-05T04:43:41.3954959Z ##[endgroup]\n2025-10-05T04:43:41.3977992Z Temporarily overriding HOME='/home/runner/work/_temp/3841c34c-236d-4919-a6b2-f9ec797972bd' before making global git config changes\n2025-10-05T04:43:41.3982989Z Adding repository directory to the temporary git global config as a safe directory\n2025-10-05T04:43:41.3986596Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/manim/manim\n2025-10-05T04:43:41.4021966Z Deleting the contents of '/home/runner/work/manim/manim'\n2025-10-05T04:43:41.4025800Z ##[group]Initializing the repository\n2025-10-05T04:43:41.4030612Z [command]/usr/bin/git init /home/runner/work/manim/manim\n2025-10-05T04:43:41.4146713Z hint: Using 'master' as the name for the initial branch. This default branch name\n2025-10-05T04:43:41.4149538Z hint: is subject to change. To configure the initial branch name to use in all\n2025-10-05T04:43:41.4152387Z hint: of your new repositories, which will suppress this warning, call:\n2025-10-05T04:43:41.4154796Z hint:\n2025-10-05T04:43:41.4156354Z hint: \tgit config --global init.defaultBranch <name>\n2025-10-05T04:43:41.4158528Z hint:\n2025-10-05T04:43:41.4160342Z hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and\n2025-10-05T04:43:41.4163669Z hint: 'development'. The just-created branch can be renamed via this command:\n2025-10-05T04:43:41.4166239Z hint:\n2025-10-05T04:43:41.4167449Z hint: \tgit branch -m <name>\n2025-10-05T04:43:41.4168824Z hint:\n2025-10-05T04:43:41.4170532Z hint: Disable this message with \"git config set advice.defaultBranchName false\"\n2025-10-05T04:43:41.4172588Z Initialized empty Git repository in /home/runner/work/manim/manim/.git/\n2025-10-05T04:43:41.4176076Z [command]/usr/bin/git remote add origin https://github.com/asato425/manim\n2025-10-05T04:43:41.4204781Z ##[endgroup]\n2025-10-05T04:43:41.4207157Z ##[group]Disabling automatic garbage collection\n2025-10-05T04:43:41.4209466Z [command]/usr/bin/git config --local gc.auto 0\n2025-10-05T04:43:41.4238773Z ##[endgroup]\n2025-10-05T04:43:41.4240988Z ##[group]Setting up auth\n2025-10-05T04:43:41.4246494Z [command]/usr/bin/git config --local --name-only --get-regexp core\\.sshCommand\n2025-10-05T04:43:41.4279587Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'core\\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :\"\n2025-10-05T04:43:41.4629057Z [command]/usr/bin/git config --local --name-only --get-regexp http\\.https\\:\\/\\/github\\.com\\/\\.extraheader\n2025-10-05T04:43:41.4662347Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'http\\.https\\:\\/\\/github\\.com\\/\\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :\"\n2025-10-05T04:43:41.4876489Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***\n2025-10-05T04:43:41.4910791Z ##[endgroup]\n2025-10-05T04:43:41.4913683Z ##[group]Fetching the repository\n2025-10-05T04:43:41.4922977Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +fd6f9b8538a1d795010d0d65aea89b7b71984efe:refs/remotes/origin/work_1005_1303\n2025-10-05T04:43:41.8591107Z From https://github.com/asato425/manim\n2025-10-05T04:43:41.8594077Z  * [new ref]         fd6f9b8538a1d795010d0d65aea89b7b71984efe -> origin/work_1005_1303\n2025-10-05T04:43:41.8628206Z ##[endgroup]\n2025-10-05T04:43:41.8630354Z ##[group]Determining the checkout info\n2025-10-05T04:43:41.8633072Z ##[endgroup]\n2025-10-05T04:43:41.8635397Z [command]/usr/bin/git sparse-checkout disable\n2025-10-05T04:43:41.8679285Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig\n2025-10-05T04:43:41.8709004Z ##[group]Checking out the ref\n2025-10-05T04:43:41.8712274Z [command]/usr/bin/git checkout --progress --force -B work_1005_1303 refs/remotes/origin/work_1005_1303\n2025-10-05T04:43:41.8892343Z Switched to a new branch 'work_1005_1303'\n2025-10-05T04:43:41.8896029Z branch 'work_1005_1303' set up to track 'origin/work_1005_1303'.\n2025-10-05T04:43:41.8903020Z ##[endgroup]\n2025-10-05T04:43:41.8939309Z [command]/usr/bin/git log -1 --format=%H\n2025-10-05T04:43:41.8962338Z fd6f9b8538a1d795010d0d65aea89b7b71984efe\n2025-10-05T04:43:41.8975999Z ##[group]Removing auth\n2025-10-05T04:43:41.8981148Z [command]/usr/bin/git config --local --name-only --get-regexp core\\.sshCommand\n2025-10-05T04:43:41.9013978Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'core\\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :\"\n2025-10-05T04:43:41.9255281Z [command]/usr/bin/git config --local --name-only --get-regexp http\\.https\\:\\/\\/github\\.com\\/\\.extraheader\n2025-10-05T04:43:41.9277018Z http.https://github.com/.extraheader\n2025-10-05T04:43:41.9286731Z [command]/usr/bin/git config --local --unset-all http.https://github.com/.extraheader\n2025-10-05T04:43:41.9318615Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'http\\.https\\:\\/\\/github\\.com\\/\\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :\"\n2025-10-05T04:43:41.9527048Z ##[endgroup]\n\n\n===== Build and Lint/3_Set up Python 3.10.txt =====\n﻿2025-10-05T04:43:41.9790020Z ##[group]Run actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065\n2025-10-05T04:43:41.9791367Z with:\n2025-10-05T04:43:41.9792368Z   python-version: 3.10\n2025-10-05T04:43:41.9793151Z   check-latest: false\n2025-10-05T04:43:41.9794121Z   token: ***\n2025-10-05T04:43:41.9794839Z   update-environment: true\n2025-10-05T04:43:41.9795677Z   allow-prereleases: false\n2025-10-05T04:43:41.9796505Z   freethreaded: false\n2025-10-05T04:43:41.9797245Z ##[endgroup]\n2025-10-05T04:43:42.1551359Z ##[group]Installed versions\n2025-10-05T04:43:42.1669276Z Successfully set up CPython (3.10.18)\n2025-10-05T04:43:42.1672044Z ##[endgroup]\n\n\n===== Build and Lint/4_Cache pip dependencies.txt =====\n﻿2025-10-05T04:43:42.2417836Z ##[group]Run actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830\n2025-10-05T04:43:42.2419084Z with:\n2025-10-05T04:43:42.2419744Z   path: ~/.cache/pip\n2025-10-05T04:43:42.2421160Z   key: Linux-python-3.10.18-pip-70233f87bcb367b6f1a53d0e85e8cf9d82b514bd7af2d0eef0416538bbd28a66\n2025-10-05T04:43:42.2423178Z   restore-keys: Linux-python-3.10.18-pip-\n\n2025-10-05T04:43:42.2424207Z   enableCrossOsArchive: false\n2025-10-05T04:43:42.2425080Z   fail-on-cache-miss: false\n2025-10-05T04:43:42.2425918Z   lookup-only: false\n2025-10-05T04:43:42.2489387Z   save-always: false\n2025-10-05T04:43:42.2490211Z env:\n2025-10-05T04:43:42.2491588Z   pythonLocation: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.2493105Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.10.18/x64/lib/pkgconfig\n2025-10-05T04:43:42.2494571Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.2495866Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.2497198Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.2498562Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.10.18/x64/lib\n2025-10-05T04:43:42.2499661Z ##[endgroup]\n2025-10-05T04:43:42.5365266Z Cache not found for input keys: Linux-python-3.10.18-pip-70233f87bcb367b6f1a53d0e85e8cf9d82b514bd7af2d0eef0416538bbd28a66, Linux-python-3.10.18-pip-\n\n\n===== Build and Lint/5_Install project dependencies.txt =====\n﻿2025-10-05T04:43:42.5472963Z ##[group]Run python -m pip install --upgrade pip\n2025-10-05T04:43:42.5474284Z \u001b[36;1mpython -m pip install --upgrade pip\u001b[0m\n2025-10-05T04:43:42.5475410Z \u001b[36;1mpip install -r requirements.txt\u001b[0m\n2025-10-05T04:43:42.5476429Z \u001b[36;1mpip install -e .\u001b[0m\n2025-10-05T04:43:42.5574080Z shell: /usr/bin/bash -e {0}\n2025-10-05T04:43:42.5575007Z env:\n2025-10-05T04:43:42.5575951Z   pythonLocation: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.5577546Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.10.18/x64/lib/pkgconfig\n2025-10-05T04:43:42.5579129Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.5580577Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.5582170Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.10.18/x64\n2025-10-05T04:43:42.5583606Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.10.18/x64/lib\n2025-10-05T04:43:42.5584818Z ##[endgroup]\n2025-10-05T04:43:49.8068696Z Requirement already satisfied: pip in /opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages (25.2)\n2025-10-05T04:43:50.9106146Z Ignoring audioop-lts: markers 'python_version >= \"3.13\"' don't match your environment\n2025-10-05T04:43:50.9586488Z Collecting addict (from -r requirements.txt (line 1))\n2025-10-05T04:43:51.0036823Z   Downloading addict-2.4.0-py3-none-any.whl.metadata (1.0 kB)\n2025-10-05T04:43:51.0142275Z Collecting appdirs (from -r requirements.txt (line 2))\n2025-10-05T04:43:51.0178152Z   Downloading appdirs-1.4.4-py2.py3-none-any.whl.metadata (9.0 kB)\n2025-10-05T04:43:51.0298632Z Collecting colour (from -r requirements.txt (line 4))\n2025-10-05T04:43:51.0348322Z   Downloading colour-0.1.5-py2.py3-none-any.whl.metadata (18 kB)\n2025-10-05T04:43:51.0625696Z Collecting diskcache (from -r requirements.txt (line 5))\n2025-10-05T04:43:51.0686199Z   Downloading diskcache-5.6.3-py3-none-any.whl.metadata (20 kB)\n2025-10-05T04:43:51.1279077Z Collecting ipython>=8.18.0 (from -r requirements.txt (line 6))\n2025-10-05T04:43:51.1320087Z   Downloading ipython-8.37.0-py3-none-any.whl.metadata (5.1 kB)\n2025-10-05T04:43:51.1538824Z Collecting isosurfaces (from -r requirements.txt (line 7))\n2025-10-05T04:43:51.1594357Z   Downloading isosurfaces-0.1.2-py3-none-any.whl.metadata (3.3 kB)\n2025-10-05T04:43:51.3422638Z Collecting fontTools (from -r requirements.txt (line 8))\n2025-10-05T04:43:51.3462643Z   Downloading fonttools-4.60.1-cp310-cp310-manylinux2014_x86_64.manylinux_2_17_x86_64.whl.metadata (112 kB)\n2025-10-05T04:43:51.4063654Z Collecting manimpango>=0.6.0 (from -r requirements.txt (line 9))\n2025-10-05T04:43:51.4115699Z   Downloading manimpango-0.6.0.tar.gz (4.1 MB)\n2025-10-05T04:43:51.4403895Z      ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 4.1/4.1 MB 151.0 MB/s  0:00:00\n2025-10-05T04:43:51.5472453Z   Installing build dependencies: started\n2025-10-05T04:43:53.3087463Z   Installing build dependencies: finished with status 'done'\n2025-10-05T04:43:53.3093531Z   Getting requirements to build wheel: started\n2025-10-05T04:43:53.9521613Z   Getting requirements to build wheel: finished with status 'error'\n2025-10-05T04:43:53.9573055Z   error: subprocess-exited-with-error\n2025-10-05T04:43:53.9573676Z   \n2025-10-05T04:43:53.9574435Z   × Getting requirements to build wheel did not run successfully.\n2025-10-05T04:43:53.9575118Z   │ exit code: 1\n2025-10-05T04:43:53.9575518Z   ╰─> [25 lines of output]\n2025-10-05T04:43:53.9575945Z       Package 'pangocairo' was not found\n2025-10-05T04:43:53.9576479Z       Traceback (most recent call last):\n2025-10-05T04:43:53.9585067Z         File \"<string>\", line 137, in check_min_version\n2025-10-05T04:43:53.9586200Z         File \"/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/subprocess.py\", line 369, in check_call\n2025-10-05T04:43:53.9587170Z           raise CalledProcessError(retcode, cmd)\n2025-10-05T04:43:53.9588299Z       subprocess.CalledProcessError: Command '['pkg-config', '--print-errors', '--atleast-version', '1.30.0', 'pangocairo']' returned non-zero exit status 1.\n2025-10-05T04:43:53.9589385Z       \n2025-10-05T04:43:53.9589887Z       During handling of the above exception, another exception occurred:\n2025-10-05T04:43:53.9590941Z       \n2025-10-05T04:43:53.9591265Z       Traceback (most recent call last):\n2025-10-05T04:43:53.9592779Z         File \"/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py\", line 389, in <module>\n2025-10-05T04:43:53.9593962Z           main()\n2025-10-05T04:43:53.9595092Z         File \"/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py\", line 373, in main\n2025-10-05T04:43:53.9596399Z           json_out[\"return_val\"] = hook(**hook_input[\"kwargs\"])\n2025-10-05T04:43:53.9597873Z         File \"/opt/hostedtoolcache/Python/3.10.18/x64/lib/python3.10/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py\", line 143, in get_requires_for_build_wheel\n2025-10-05T04:43:53.9599210Z           return hook(config_settings)\n2025-10-05T04:43:53.9600410Z         File \"/tmp/pip-build-env-338iybi2/overlay/lib/python3.10/site-packages/setuptools/build_meta.py\", line 331, in get_requires_for_build_wheel\n2025-10-05T04:43:53.9601851Z           return self._get_build_requires(config_settings, requirements=[])\n2025-10-05T04:43:53.9603149Z         File \"/tmp/pip-build-env-338iybi2/overlay/lib/python3.10/site-packages/setuptools/build_meta.py\", line 301, in _get_build_requires\n2025-10-05T04:43:53.9604216Z           self.run_setup()\n2025-10-05T04:43:53.9605278Z         File \"/tmp/pip-build-env-338iybi2/overlay/lib/python3.10/site-packages/setuptools/build_meta.py\", line 317, in run_setup\n2025-10-05T04:43:53.9606618Z           exec(code, locals())\n2025-10-05T04:43:53.9607165Z         File \"<string>\", line 204, in <module>\n2025-10-05T04:43:53.9607790Z         File \"<string>\", line 140, in check_min_version\n2025-10-05T04:43:53.9608427Z       __main__.RequiredDependencyException: pangocairo >= 1.30.0 is required\n2025-10-05T04:43:53.9608960Z       [end of output]\n2025-10-05T04:43:53.9609244Z   \n2025-10-05T04:43:53.9609735Z   note: This error originates from a subprocess, and is likely not a problem with pip.\n2025-10-05T04:43:53.9610438Z error: subprocess-exited-with-error\n2025-10-05T04:43:53.9610733Z \n2025-10-05T04:43:53.9611313Z × Getting requirements to build wheel did not run successfully.\n2025-10-05T04:43:53.9612194Z │ exit code: 1\n2025-10-05T04:43:53.9612625Z ╰─> See above for output.\n2025-10-05T04:43:53.9612882Z \n2025-10-05T04:43:53.9613289Z note: This error originates from a subprocess, and is likely not a problem with pip.\n2025-10-05T04:43:54.0382256Z ##[error]Process completed with exit code 1.\n\n\n===== Build and Lint/20_Post Checkout repository.txt =====\n﻿2025-10-05T04:43:54.0501874Z Post job cleanup.\n2025-10-05T04:43:54.1433738Z [command]/usr/bin/git version\n2025-10-05T04:43:54.1476867Z git version 2.51.0\n2025-10-05T04:43:54.1523168Z Temporarily overriding HOME='/home/runner/work/_temp/d963074a-ed7f-4dcf-b080-ca47bdcbbdc7' before making global git config changes\n2025-10-05T04:43:54.1524593Z Adding repository directory to the temporary git global config as a safe directory\n2025-10-05T04:43:54.1537317Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/manim/manim\n2025-10-05T04:43:54.1573512Z [command]/usr/bin/git config --local --name-only --get-regexp core\\.sshCommand\n2025-10-05T04:43:54.1605976Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'core\\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :\"\n2025-10-05T04:43:54.1829672Z [command]/usr/bin/git config --local --name-only --get-regexp http\\.https\\:\\/\\/github\\.com\\/\\.extraheader\n2025-10-05T04:43:54.1861107Z [command]/usr/bin/git submodule foreach --recursive sh -c \"git config --local --name-only --get-regexp 'http\\.https\\:\\/\\/github\\.com\\/\\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :\"\n\n\n===== Build and Lint/21_Complete job.txt =====\n﻿2025-10-05T04:43:54.2181085Z Cleaning up orphan processes\n" 
    
    #test_logの文字数を数える
    char_count = len(test_log)
    print(f"Character count in test_log: {char_count}")

    filtered_log = parser.extract_error_context(test_log)
    char_count_filtered = len(filtered_log)
    print(f"Character count in filtered_log: {char_count_filtered}")
    print("Filtered log:")
    print(filtered_log)